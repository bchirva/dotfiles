#!/usr/bin/env sh

main() {
    help_msg="audio-ctrl
        list <input/output> - print available devices
        id <input/output> - print active device id 
        choose <input/output> <id> - choose active device
        mute <input/output> - toggle mute for active device
        volume <input/output> - change volume level (in %) for active device"

    case $1 in 
        list) device_list "$2";; 
        id) active_device_id "$2";; 
        choose) change_active_device "$2" "$3";;
        mute) set_device_mute "$2" ;;
        volume) set_device_volume "$2" "$3" ;;
        -h|--help) printf '%s\n' "$help_msg";;
        *) exit 2;;
    esac
}

device_list() {
    device_type=$1
    case $device_type in
        output) 
            device_list="$(pactl list sinks)"
            get_volume_cmd='pactl get-sink-volume'
            get_muted_cmd='pactl get-sink-mute'
            device_id="Sink #"
        ;;
        input)  
            device_list="$(pactl list sources)"
            get_volume_cmd='pactl get-source-volume'
            get_muted_cmd='pactl get-source-mute'
            device_id="Source #"
        ;;
        *) exit 2
    esac

    device_idx=1 
    device_port_idx=1
    device_count=$(printf '%s\n' "$device_list" | grep -c "$device_id")
   
    while [ "$device_idx" -le "$device_count" ]; do
        if [ "$device_type" = "input" ]; then
            monitor_of_sink=$(printf '%s\n' "$device_list" \
                | grep "Monitor of Sink" \
                | sed -n "${device_idx}{s/^\s*//; s/^\([^ ]* \)\{3\}//; p}")

            if [ "$monitor_of_sink" != "n/a" ]; then
                device_idx=$((device_idx + 1))
                continue
            fi
        fi

        id=$(printf '%s\n' "$device_list" \
            | grep "Name:" \
            | sed -n "${device_idx}{s/^\s*//; s/^[^ ]* //; p}") 

        port=$(printf '%s\n' "$device_list" \
            | grep "Active Port" \
            | sed -n "${device_port_idx}{s/^\s*//; s/^\([^ ]* \)\{2\}//; p}")

        name=$(printf '%s\n' "$device_list" \
            | grep "$port" \
            | sed -n "1{s/^\s*//; s/^[^ ]* //; s/ (.*$// p}")

        volume=$($get_volume_cmd "$id" \
            | sed -n '1{s/^\([^ ]* \)\{4\}//; s/%.*$//; p}')

        muted=$($get_muted_cmd "$id" \
            | sed 's/^[^ ]* //; s/yes/true/; s/no/false/')
       
        device_idx=$((device_idx + 1)) && device_port_idx=$((device_port_idx + 1))
        printf '%s\t%s\t%s\t%s\n' "$id" "$name" "$volume" "$muted"
    done
}

active_device_id() {
    device_type=$1
    case $device_type in
        output) pactl get-default-sink ;;
        input)  pactl get-default-source ;;
        *) exit 2 
    esac
}

change_active_device() {
    device_type=$1
    device_id=$2
    
    case $device_type in
        output)
            set_active_device_cmd='pactl set-default-sink'
            move_channel_to_device_cmd='pactl move-sink-input'
            channels=$(pactl list sink-inputs short)
            ;;
        input)
            set_active_device_cmd='pactl set-default-source'
            move_channel_to_device_cmd='pactl move-source-output'
            channels=$(pactl list source-outputs short)
            ;;
        *) exit 2
    esac

    $set_active_device_cmd "${device_id}"

    printf '%s\n' "$channels" | while IFS= read -r line; do 
        channel_id="$(printf '%s\n' "$line" | cut -f 1)"
        $move_channel_to_device_cmd "$channel_id" "$device_id"
    done 
}

set_device_volume() {
    device_type=$1
    volume_level=$2

    case $device_type in
    output) pactl set-sink-volume   "$(pactl get-default-sink)"   "${volume_level}%" ;;
    input)  pactl set-source-volume "$(pactl get-default-source)" "${volume_level}%" ;;
    *) exit 2 ;;
    esac
}

set_device_mute() {
    device_type=$1

    case $device_type in
    output) pactl set-sink-mute   "$(pactl get-default-sink)"   toggle ;;
    input)  pactl set-source-mute "$(pactl get-default-source)" toggle ;;
    *) exit 2 ;;
    esac
}

main "$@"
