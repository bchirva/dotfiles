#!/usr/bin/env sh

main() {
    help_msg="audio-ctrl
        list <input/output> - print json-list of available devices
        info <input/output> - print json-object with active device properties
        choose <input/output> <id> - choose active device
        set <input/output> <args> 
            -m - toggle mute
            -v <volume level> - change volume (in %)"

    case $1 in 
        list) device_list "$2";; 
        info) active_device_info "$2";; 
        choose) shift; change_active_device "$@";;
        set) shift; change_active_device_settings "$@";;
        -h|--help) printf '%s\n' "${help_msg}";;
        *) exit 2;;
    esac
}

device_list() {
    device_type=$1
    case $device_type in
        output) 
            device_list="$(pactl list sinks)"
            get_volume_cmd='pactl get-sink-volume'
            get_muted_cmd='pactl get-sink-mute'
            device_id="Sink #"
        ;;
        input)  
            device_list="$(pactl list sources)"
            get_volume_cmd='pactl get-source-volume'
            get_muted_cmd='pactl get-source-mute'
            device_id="Source #"
        ;;
        *) exit 2
    esac

    json_array="[]"

    i=0
    count=$(printf '%s\n' "$device_list" | grep -c "$device_id")
    while [ "$i" -lt "$count" ]; do
        if [ "$device_type" = "input" ]; then
            monitor_of_sink=$(printf '%s\n' "$device_list" \
                | grep -e "Monitor of Sink" \
                | head -n $((i + 1)) \
                | tail -n 1 \
                | awk '{print $4}')

            if [ "$monitor_of_sink" != "n/a" ]; then
                i=$((i + 1))
                continue
            fi
        fi

        id=$(printf '%s\n' "$device_list" \
            | grep -e "Name:" \
            | head -n $((i + 1)) \
            | tail -n 1 \
            | awk '{print $2}')

        device=$(printf '%s\n' "$device_list" \
            | grep -e 'Active Port' \
            | head -n $((i + 1)) \
            | tail -n 1 \
            | awk '{print $3}')

        name=$(printf '%s\n' "$device_list" \
            | grep -e "$device" \
            | head -n 1 \
            | cut -d ':' -f 2 \
            | cut -d '(' -f 1 \
            | sed 's/^[[:blank:]]*//;s/[[:blank:]]*$//')

        volume=$($get_volume_cmd "$id" \
            | awk '{print $5}' \
            | sed 's/%//')

        muted=$($get_muted_cmd "$id" \
            | awk '{print $2}' \
            | flag-to-bool)

        json_array=$(printf '%s\n' "$json_array" \
            | jq ". += [{id: \"$id\", port: \"$device\", name: \"$name\", volume: $volume, muted: $muted}]")

        i=$((i + 1))
    done

    printf '%s\n' "$json_array"
}

active_device_info() {
    device_type=$1

    case $device_type in
        output) id=$(pactl get-default-sink) ;;
        input)  id=$(pactl get-default-source) ;;
        *) exit 2 
    esac

    device_list "${device_type}" | jq ".[] | select(.id == \"${id}\")"
}

change_active_device() {
    device_type=$1
    device_id=$2
    
    case $device_type in
        output)
            set_active_device_cmd='pactl set-default-sink'
            move_channel_to_device_cmd='pactl move-sink-input'
            channels=$(pactl list sink-inputs short)
            ;;
        input)
            set_active_device_cmd='pactl set-default-source'
            move_channel_to_device_cmd='pactl move-source-output'
            channels=$(pactl list source-outputs short)
            ;;
        *) exit 2
    esac

    $set_active_device_cmd "${device_id}"

    i=0
    channels_count=$(printf '%s\n' "$channels" | wc -l)
    while [ "$i" -lt "$channels_count" ]; do
        channel_id=$(printf '%s\n' "$channels" \
            | sed -n "$((i + 1))p" \
            | awk '{print $1}')

        $move_channel_to_device_cmd "$channel_id" "$device_id"
        i=$((i + 1))
    done
}

change_active_device_settings() {
    device_type=$1

    case $device_type in
    output)
        id=$(pactl get-default-sink)
        set_volume_cmd='pactl set-sink-volume'
        set_muted_cmd='pactl set-sink-mute'
    ;;
    input)
        id=$(pactl get-default-source)
        set_volume_cmd='pactl set-source-volume'
        set_muted_cmd='pactl set-source-mute'
    ;;
    *) exit 2
    esac

    shift
    while getopts v:m PARAMS
    do
        case "${PARAMS}" in
            v) $set_volume_cmd "${id}" "${OPTARG}%" ;;
            m) $set_muted_cmd "${id}" toggle ;;
            *) exit 2 ;;
        esac
    done
}

main "$@"
