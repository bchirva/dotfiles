#!/usr/bin/env sh

main() {
    help_msg="network-ctrl
        system
            status - print network status
            toggle <on/off> - toggle network
        device
            list - print json-list of devices
            toggle <device> <on/off> - toggle device
        wifi
            list - print json-list of wifi networks
            toggle <on/off> - toggle wifi
            connect <ssid> [password] - connect to wifi network
            disconnect <ssid> - disconnect from wifi network
        vpn
            list - print json-list of vpn networks
        connection
            list - print json-list of active connections"

    case $1 in 
        system)
            case $2 in 
                status) network_status ;;
                toggle) toggle_network "$3";;
                *) exit 2;;
            esac ;;
        device)
            case $2 in 
                list) device_list ;;
                toggle) shift 2; toggle_device "$@";;
                *) exit 2;;
            esac ;;
        wifi)
            case $2 in 
                list) wifi_list_json ;;
                toggle) toggle_wifi "$3";;
                connect) shift 2; connect_to_wifi "$@";;
                disconnect) disconnect_from_wifi "$3" ;;
                *) exit 2
            esac ;;
        vpn)
            case $2 in 
                list) vpn_list_json ;;
                *) exit 2;;
            esac ;;
        connection)
            case $2 in 
                list) active_connections ;;
                *) exit 2;;
            esac ;;
        -h|--help) printf '%s\n' "${help_msg}";;
        *) exit 2 
        ;;
    esac 
}

network_status() {
    nmcli networking \
        | sed "s/\<enabled\>/true/; s/\<disabled\>/false/"
}

toggle_network() {
    mode=$1 # on/off 
    nmcli networking "${mode}"
}

device_list() {
    devices=$(nmcli -t device status \
        | grep --color=never -E "ethernet|wifi" \
        | grep --color=never -Ev "unavailable|unmanaged|p2p")

    printf '%s\n' "${devices}" | while IFS= read -r line; do
        device_name=$(printf '%s\n' "${line}" \
            | cut -d ':' -f 1)
        device_type=$(printf '%s\n' "${line}" \
            | cut -d ':' -f 2 )
        device_status=$(printf '%s\n' "${line}" \
            | cut -d ':' -f 3 \
            | sed 's/\<connected\>/true/ ; s/\<disconnected\>/false/')

        printf '%s\t%s\t%s\n' "$device_name" "$device_type" "$device_status"
    done 
}

toggle_device() {
    device=$1
    mode=$2 # on/off

    case $mode in
        on)  nmcli device connect "${device}" ;;
        off) nmcli device disconnect "${device}" ;;
        *) exit 2;;
    esac
}

# Wifi
wifi_list_json() { 
    wifi_networks=$(nmcli -t -f ssid,signal,security device wifi list \
        | grep -v "^:")
    known_wifi_networks=$(nmcli -t -f name,type,device connection \
        | grep "wireless" \
        | cut -d ':' -f 1 )
 
    printf '%s\n' "${wifi_networks}" | while IFS= read -r line; do
        ssid=$(printf '%s\n' "${line}" \
            | cut -d ':' -f 1)
        signal=$(printf '%s\n' "${line}" \
            | cut -d ':' -f 2)
        security=$(printf '%s\n' "${line}" \
            | cut -d ':' -f 3)

        printf '%s\n' "$known_wifi_networks" | grep -q "$ssid" \
            && known=true || known=false 

        printf '%s\t%s\t%s\t%s\n' "$ssid" "$security" "$signal" "$known"
    done 
}

toggle_wifi() {
    mode=$1 # on/off
    nmcli radio wifi "${mode}"
}

connect_to_wifi() {
    network_ssid="$1"
    network_password="$2"

    if [ -z "${network_password}" ] 
    then
        nmcli connection up "${network_ssid}"
    else
        nmcli device wifi connect "${network_ssid}" password "${network_password}"
    fi
}

disconnect_from_wifi() {
    network_ssid=$1
    nmcli connection down "${network_ssid}"
}

vpn_list_json() {
    echo ""
}

# Connections
active_connections() {
    connections=$(nmcli -t -f device,name connection show --active --order active:name)

    printf '%s\n' "${connections}" | while IFS= read -r line; do 
        connection_device=$(printf '%s\n' "${line}" \
            | cut -d ':' -f 1)
        connection_name=$(printf '%s\n' "${line}" \
            | cut -d ':' -f 2)

        printf '%s\t%s\n' "$connection_device" "$connection_name"
    done 
}

main "$@"
