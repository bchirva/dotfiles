#!/bin/bash

HELP_MSG="network-ctrl
    system
        status - print network status
        toggle <on/off> - toggle network
    device
        list - print json-list of devices
        toggle <device> <on/off> - toggle device
    wifi
        list - print json-list of wifi networks
        toggle <on/off> - toggle wifi
        connect <ssid> [password] - connect to wifi network
        disconnect <ssid> - disconnect from wifi network
    vpn
        list - print json-list of vpn networks
    connections
        list - print json-list of active connections"

# Network
function network_status {
    nmcli networking | flag-to-bool 
}

function toggle_network {
    MODE=$1 # on/off 
    nmcli networking $MODE
}

# Devices
function device_list_json {
    DEVICES=$(nmcli -t device status | grep --color=never -E "ethernet|wifi" | grep --color=never -Ev "unavailable|unmanaged|p2p")
    RESULT="[]"
    while read -r line
    do
        DEVICE_NAME=$(awk -F ':' '{print $1}' <<< "$line")
        DEVICE_TYPE=$(awk -F ':' '{print $2}' <<< "$line")
        DEVICE_STATUS=$(awk -F ':' '{print $3}' <<< "$line" | flag-to-bool)

        RESULT=$(jq ". += [{ \
            device: \"$DEVICE_NAME\", \
            type: \"$DEVICE_TYPE\", \
            status: $DEVICE_STATUS}]" \
            <<< "$RESULT")
    done <<< "$DEVICES"
    echo "$RESULT"
}

function toggle_device {
    DEVICE=$1
    MODE=$2 # on/off

    case $MODE in
        "on")  nmcli device connect $DEVICE ;;
        "off") nmcli device disconnect $DEVICE ;;
        *) exit ;;
    esac
}

# Wifi
function wifi_list_json { 
    WIFI_NETWORKS=$(nmcli -t -f ssid,signal,security device wifi list | grep -Ev "^:")
    KNOWN_WIFI_NETWORKS=$(nmcli -t -f name,type,device connection | grep -E "wireless" | awk -F ':' '{print $1}' \
        | jq --raw-input --null-input "[inputs]")
 
    RESULT="[]"
    while read -r line
    do
        SSID=$(awk -F ':' '{print $1}' <<< "$line")
        SIGNAL=$(awk -F ':' '{print $2}' <<< "$line")
        SECURITY=$(awk -F ':' '{print $3}' <<< "$line")

        if [[ $(jq ".[] | select(. == \"${SSID}\")" <<< "$KNOWN_WIFI_NETWORKS") ]]; then 
            KNOWN=true 
        else 
            KNOWN=false 
        fi
        
        RESULT=$(jq ". += [{ \
            ssid: \"$SSID\", \
            security: \"$SECURITY\", \
            signal: $SIGNAL, \
            known: $KNOWN \
        }]" <<< "$RESULT")
    done <<< "$WIFI_NETWORKS"

    echo "$RESULT"
}

function toggle_wifi {
    MODE=$1 # on/off
    nmcli radio wifi $MODE
}

function connect_to_wifi {
    NETWORK_SSID="$1"
    NETWORK_PASSWORD="$2"

    if [ -z "$NETWORK_PASSWORD" ] 
    then
        nmcli connection up "$NETWORK_SSID"
    else
        nmcli device wifi connect "$NETWORK_SSID" password "$NETWORK_PASSWORD"
    fi
}

function disconnect_from_wifi {
    NETWORK_SSID=$1
    nmcli connection down "$NETWORK_SSID"
}

# VPN
function vpn_list_json {
    # VPN_NETWORKS=$()
    # RESULT="[]"
    # while read -r line; do
    #     NAME=""
    #     TYPE=""
    #     STATUS=false
    #
    #     RESULT=$(jq ". += [{ \
    #         name: \"$SSID\", \
    #         type: \"$TYPE\", \
    #         status: $STATUS \
    #     }]" <<< "$RESULT")
    # done <<< "$VPN_NETWORKS"
    #
    echo "[]"
}

# Connections
function active_connections {
    CONNECTIONS=$(nmcli -t -f device,name connection show --active --order active:name)
    RESULT="[]"
    while read -r line
    do 
        CONNECTION_DEVICE=$(awk -F ':' '{print $1}' <<< "$line")
        CONNECTION_NAME=$(awk -F ':' '{print $2}' <<< "$line")
        RESULT=$(jq ". += [{ \
            connection: \"$CONNECTION_NAME\", \
            device: \"$CONNECTION_DEVICE\"}]" \
            <<< "$RESULT")
    done <<< "$CONNECTIONS"
    echo "$RESULT"
}

# MAIN
case $1 in 
    system)
        case $2 in 
            status) network_status ;;
            toggle) toggle_network $3;;
            *) exit 2;;
        esac ;;
    device)
        case $2 in 
            list) device_list_json ;;
            toggle) toggle_device $3 $4;;
            *) exit 2;;
        esac ;;
    wifi)
        case $2 in 
            list) wifi_list_json ;;
            toggle) toggle_wifi $3;;
            connect) connect_to_wifi "${@:3}";;
            disconnect) disconnect_from_wifi $3 ;;
            *) exit 2
        esac ;;
    vpn)
        case $2 in 
            list) vpn_list_json ;;
            *) exit 2;;
        esac ;;
    connections)
        case $2 in 
            list) active_connections ;;
            *) exit 2;;
        esac ;;
    -h|--help) echo -e "${HELP_MSG}";;
    *) exit 2 
    ;;
esac 
