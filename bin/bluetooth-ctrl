#!/bin/bash 

HELP_MSG="bluetooth-ctrl
    status - print json-object with bluetooth status
    power <on/off> - toggle power
    pairable <on/off> - toggle pairable
    discoverable <on/off> - toggle discoverable
    scan <on/off> - toggle scanning
    device
        list - print json-list of devices
        info - print json-object with device properties
        connect <mac> - connect to device
        disconnect <mac> - disconnect from device
        remove <mac> - disconnect and forget device"

# Bluetooth
function bluetooth_status() {
    STATUS=$(bluetoothctl show)
    POWERED=$(grep "PowerState:" <<< "${STATUS}" | awk '{print $2}' | flag-to-bool )
    SCANNING=$(grep "Discovering:" <<< "${STATUS}" | awk '{print $2}' | flag-to-bool )
    PAIRABLE=$(grep "Pairable:" <<< "${STATUS}"| awk '{print $2}' | flag-to-bool )
    DISCOVERABLE=$(grep "Discoverable:" <<< "${STATUS}" | awk '{print $2}' | flag-to-bool )

    jq -n "{ \
        powered: ${POWERED}, \
        scanning: ${SCANNING}, \
        pairable: ${PAIRABLE}, \
        discoverable: ${DISCOVERABLE} }"
}

function toggle_power() {
    MODE=$1
    case $MODE in
        "on") 
            if rfkill list bluetooth | grep -q "blocked: yes"; then 
                rfkill unblock bluetooth && sleep 3
            fi 
            bluetoothctl power on;;
        "off") bluetoothctl power off;;
        *) exit;;
    esac
}

function toggle_scan() {
    MODE=$1
    case $MODE in 
        "on") bluetoothctl --timeout 5 scan on >> /dev/null ;;
        "off") bluetoothctl scan off ;;
        *) exit ;;
    esac 
}

toggle_discoverable() {
    MODE=$1
    case $MODE in
        "on") bluetoothctl discoverable on ;;
        "off") bluetoothctl discoverable off ;;
        *) exit ;;
    esac 
}

toggle_pairable() {
    MODE=$1
    case $MODE in 
        "on") bluetoothctl pairable on ;;
        "off") bluetoothctl pairable off ;;
        *) exit ;;
    esac 
}

#Devices
function devices_list() {
    DEVICES=$(bluetoothctl devices)
    RESULT="[]"

    while read -r line
    do
        DEVICE_ID=$(awk '{print $2}' <<< "$line")
        DEVICE_INFO=$(device_info "${DEVICE_ID}")
        RESULT=$(jq ". += [$(device_info "${DEVICE_ID}")]" <<< "$RESULT")
    done <<< "$DEVICES"

    echo "${RESULT}"
}

function device_info() {
    DEVICE_ID=$1

    DEVICE_INFO=$(bluetoothctl info "${DEVICE_ID}")

    NAME=$(grep "Name:" <<< "${DEVICE_INFO}" | awk '{start=index($0, $2); print substr($0, start)}')
    CLASS=$(grep "Class:" <<< "${DEVICE_INFO}" | awk '{print $2}' | flag-to-bool)
    ICON=$(grep "Icon:" <<< "${DEVICE_INFO}" | awk '{print $2}' | flag-to-bool)
    PAIRED=$(grep "Paired:" <<< "${DEVICE_INFO}" | awk '{print $2}' | flag-to-bool)
    BONDED=$(grep "Bonded:" <<< "${DEVICE_INFO}" | awk '{print $2}' | flag-to-bool)
    TRUSTED=$(grep "Trusted:" <<< "${DEVICE_INFO}" | awk '{print $2}' | flag-to-bool)
    BLOCKED=$(grep "Blocked:" <<< "${DEVICE_INFO}" | awk '{print $2}' | flag-to-bool)
    CONNECTED=$(grep "Connected:" <<< "${DEVICE_INFO}" | awk '{print $2}' | flag-to-bool)
    BATTERY=$(grep "Battery Percentage:" <<< "${DEVICE_INFO}" | awk '{print $4}' | sed -e "s/(//g" -e "s/)//g")
    if [ -z "${BATTERY}" ]; then BATTERY="null"; fi

    jq -n "{ \
        id: \"${DEVICE_ID}\", \
        name: \"${NAME}\", \
        class: \"${CLASS}\", \
        icon: \"${ICON}\", \
        paired: ${PAIRED}, \
        bonded: ${BONDED}, \
        trusted: ${TRUSTED}, \
        blocked: ${BLOCKED}, \
        connected: ${CONNECTED}, \
        battery: ${BATTERY} }"  
}

function connect_device() {
    DEVICE_ID=$1
    DEVICE_INFO=$(device_info "${DEVICE_ID}")

    if jq -e ".trusted | not" <<< "${DEVICE_INFO}" > /dev/null; then 
        bluetoothctl trust "${DEVICE_ID}"
    fi 

    if jq -e ".paired | not" <<< "${DEVICE_INFO}" > /dev/null; then 
        bluetoothctl pair "${DEVICE_ID}"
    fi 

    bluetoothctl connect "${DEVICE_ID}" 
}

function disconnect_device() {
    DEVICE_ID=$1
    bluetoothctl disconnect "${DEVICE_ID}"
}

function remove_device() {
    DEVICE_ID=$1
    bluetoothctl remove "${DEVICE_ID}"
}

# MAIN
case $1 in 
    status) bluetooth_status;;
    power) toggle_power $2;;
    pairable) toggle_pairable $2;;
    discoverable) toggle_discoverable $2;;
    scan) toggle_scan $2;;
    device)
        case $2 in
            list) devices_list;;
            info) device_info $3;;
            connect) connect_device $3;;
            disconnect) disconnect_device $3;;
            remove) remove_device $3;;
            *) exit 2;;
        esac;;
    -h|--help) echo -e "${HELP_MSG}" ;;
    *) exit 2;;
esac 
