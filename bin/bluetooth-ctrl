#!/usr/bin/env sh 

main() {
    help_msg="bluetooth-ctrl
        status - print json-object with bluetooth status
        power <on/off> - toggle power
        pairable <on/off> - toggle pairable
        discoverable <on/off> - toggle discoverable
        scan <on/off> - toggle scanning
        device
            list - print json-list of devices
            info - print json-object with device properties
            connect <mac> - connect to device
            disconnect <mac> - disconnect from device
            remove <mac> - disconnect and forget device"

    case $1 in 
        status) bluetooth_status;;
        power) toggle_power "$2";;
        pairable) toggle_pairable "$2";;
        discoverable) toggle_discoverable "$2";;
        scan) toggle_scan "$2";;
        device)
            case $2 in
                list) devices_list;;
                info) device_info "$3";;
                connect) connect_device "$3";;
                disconnect) disconnect_device "$3";;
                remove) remove_device "$3";;
                *) exit 2;;
            esac;;
        -h|--help) printf '%s\n' "${help_msg}" ;;
        *) exit 2;;
    esac 
}

# Bluetooth
bluetooth_status() {
    status=$(bluetoothctl show)
    powered=$(printf '%s\n' "${status}" | grep "PowerState:" \
        | awk '{print $2}' \
        | flag-to-bool )
    scanning=$(printf '%s\n' "${status}" | grep "Discovering:" \
        | awk '{print $2}' \
        | flag-to-bool )
    pairable=$(printf '%s\n' "${status}" | grep "Pairable:" \
        | awk '{print $2}' \
        | flag-to-bool )
    discoverable=$(printf '%s\n' "${status}" | grep "Discoverable:" \
        | awk '{print $2}' \
        | flag-to-bool )

    jq -n "{ \
        powered: ${powered}, \
        scanning: ${scanning}, \
        pairable: ${pairable}, \
        discoverable: ${discoverable} }"
}

toggle_power() {
    mode=$1
    case $mode in
        on) 
            if rfkill list bluetooth | grep -q "blocked: yes"; then 
                rfkill unblock bluetooth && sleep 3
            fi 
            bluetoothctl power on;;
        off) bluetoothctl power off;;
        *) exit 2;;
    esac
}

toggle_scan() {
    mode=$1
    case $mode in 
        on) bluetoothctl --timeout 5 scan on >> /dev/null ;;
        off) bluetoothctl scan off ;;
        *) exit 2;;
    esac 
}

toggle_discoverable() {
    mode=$1
    case $mode in
        on) bluetoothctl discoverable on ;;
        off) bluetoothctl discoverable off ;;
        *) exit 2;;
    esac 
}

toggle_pairable() {
    mode=$1
    case $mode in 
        on) bluetoothctl pairable on ;;
        off) bluetoothctl pairable off ;;
        *) exit 2;;
    esac 
}

#Devices
devices_list() {
    devices=$(bluetoothctl devices \
        | grep "^Device")

    result="[]"
    tmpfile=$(mktemp) || exit 1
    printf '%s\n' "${devices}" > "${tmpfile}"
    while IFS= read -r line
    do
        device_id=$(printf '%s\n' "${line}" \
            | awk '{print $2}' )
        device_info=$(device_info "${device_id}")
        if [ -n "$(printf '%s\n' "${device_info}" | jq -r '.name // empty' )" ]; then
            result=$(printf '%s\n' "${result}" \
                | jq ". += [$(device_info "${device_id}")]" )
        fi
    done < "${tmpfile}"
    rm -f "${tmpfile}"

    printf '%s\n' "${result}"
}

device_info() {
    device_id=$1

    device_info=$(bluetoothctl info "${device_id}")

    name=$(printf '%s\n' "${device_info}" \
        | grep "Name:" \
        | awk '{start=index($0, $2); print substr($0, start)}')
    class=$(printf '%s\n' "${device_info}" \
        | grep "Class:" \
        | awk '{print $2}' \
        | flag-to-bool)
    icon=$(printf '%s\n' "${device_info}" \
        | grep "Icon:" \
        | awk '{print $2}' \
        | flag-to-bool)
    paired=$(printf '%s\n' "${device_info}" \
        | grep "Paired:" \
        | awk '{print $2}' \
        | flag-to-bool)
    bonded=$(printf '%s\n' "${device_info}" \
        | grep "Bonded:" \
        | awk '{print $2}' \
        | flag-to-bool)
    trusted=$(printf '%s\n' "${device_info}" \
        | grep "Trusted:" \
        | awk '{print $2}' \
        | flag-to-bool)
    blocked=$(printf '%s\n' "${device_info}" \
        | grep "Blocked:" \
        | awk '{print $2}' \
        | flag-to-bool)
    connected=$(printf '%s\n' "${device_info}" \
        | grep "Connected:" \
        | awk '{print $2}' \
        | flag-to-bool)
    battery=$(printf '%s\n' "${device_info}" \
        | grep "Battery Percentage:" \
        | awk '{print $4}' \
        | sed -e "s/(//g" -e "s/)//g")
    
    jq -n "{ \
        id: \"${device_id}\", \
        name: \"${name}\", \
        class: \"${class}\", \
        icon: \"${icon}\", \
        paired: ${paired}, \
        bonded: ${bonded}, \
        trusted: ${trusted}, \
        blocked: ${blocked}, \
        connected: ${connected}, \
        battery: ${battery:-null} }"  
}

connect_device() {
    device_id=$1
    device_info=$(device_info "${device_id}")

    if printf '%s\n' "${device_info}" | jq -e ".trusted | not" > /dev/null; then 
        bluetoothctl trust "${device_id}"
    fi 

    if printf '%s\n' "${device_info}" | jq -e ".paired | not" > /dev/null; then 
        bluetoothctl pair "${device_id}"
    fi 

    bluetoothctl connect "${device_id}" 
}

disconnect_device() {
    device_id=$1
    bluetoothctl disconnect "${device_id}"
}

remove_device() {
    device_id=$1
    bluetoothctl remove "${device_id}"
}

main "$@"
