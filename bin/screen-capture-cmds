#!/usr/bin/env sh

main() {
    help_msg="screenshot-cmd
        select - screenshot of select area or window 
        focused - screenshot of focused window
        screen <screen name> - screenshot of whole screen (from xrandr)
        record <screen name> - start/stop record screen by name"

    timestamp_format="%Y%m%d-%H%M%S"
    screenshots_path="$HOME/Images/screenshots"
    records_path="$HOME/Videos/records"
    clipboard_cmd='xclip -selection clipboard -target image/png -i $f'
    notification_cmd='notify-send -u normal -i accessories-screenshot "Screenshot" "saved in $f"'

    case $1 in 
        select) screenshot_select;;
        focused) screenshot_focused;;
        screen) screenshot_screen "$2";;
        record) record_screen "$2";;
        -h|--help) printf '%s\n' "${help_msg}";;
        *) exit 2;;
    esac 
}


screenshot_select() {
    scrot -s -f "${screenshots_path}/screenshot_${timestamp_format}.png" -e "${clipboard_cmd} & ${notification_cmd}"
}

screenshot_focused() {
    scrot -u -f "${screenshots_path}/screenshot_${timestamp_format}.png" -e "${clipboard_cmd} & ${notification_cmd}"
}

screenshot_screen() {
    screen="$1"
    geometry=$(xrandr | grep -A1 "^${screen} connected" \
        | grep -oP '\d+x\d+\+\d+\+\d+' \
        | awk -F '[x+]' '{print $3 "," $4 "," $1 "," $2}')

    scrot -a "${geometry}" -f "${screenshots_path}/screenshot_${timestamp_format}.png" \
                    -e "${clipboard_cmd} & ${notification_cmd}"
}

record_screen() {
    record_pid_file="${XDG_RUNTIME_DIR}/ffmpeg.record.pid"

    if [ -f "${record_pid_file}" ]; then 
        ffmpeg_pid="$(head -n 1 "${record_pid_file}")"
        kill -INT "${ffmpeg_pid}" 
        wait "${ffmpeg_pid}"
        notify-send -u normal -i record-desktop "Screen recording has finished" "Record saved in $(tail -n 1 "${record_pid_file}")"
        rm "${record_pid_file}"
        exit 0
    fi 

    screen="$1"

    if [ -z "${screen}" ]; then 
        exit 
    fi

    geometry_output=$(
        xrandr |
        grep -A1 "^${screen} connected" |
        grep -o '[0-9]\+x[0-9]\++[0-9]\++[0-9]\+' |
        awk -F '[x+]' '{print $1 "x" $2 "\n" $3 "," $4}'
    )

    geometry_size=$(printf '%s\n' "$geometry_output" | sed -n '1p')
    geometry_offset=$(printf '%s\n' "$geometry_output" | sed -n '2p')

    inputs="-f x11grab -video_size ${geometry_size} -framerate 25 -i ${DISPLAY}+${geometry_offset}"
    codecs="-c:v libx264"
    formats="-pix_fmt yuv420p"
    extra=""
    record_path="${records_path}/record_$(date +${timestamp_format}).mkv"

    if [ "$(audio-ctrl info input | jq ".muted")" = "false" ]; then 
        inputs="${inputs} -f pulse -ac 2 -i default"
        codecs="${codecs} -c:a aac"
        formats="${formats} -b:a 128k"
        extra="${extra} -preset ultrafast -threads 0"
    fi 

    ffmpeg $inputs $codecs $formats $extra $record_path &

    printf '%s\n%s\n' "$!" "${record_path}" > "${record_pid_file}"
    notify-send -u normal -i record-desktop "Screen ${screen} is recording" "Record will be saved in ${record_path}"
}

main "$@"

